name: Issue Implementation Planner

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  plan-implementation:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    # Run if: new issue opened OR comment mentions @claude (case-insensitive)
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate response with Claude
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ${{ github.event_name == 'issues' && 'A new issue has been opened. Please analyze it and provide an implementation plan.' || format('You were mentioned in a comment on issue #{0}. Please respond to the request.', github.event.issue.number) }}

            ## Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            **Issue description:**
            ${{ github.event.issue.body }}

            ${{ github.event_name == 'issue_comment' && format('**Comment from @{0}:**\n{1}', github.event.comment.user.login, github.event.comment.body) || '' }}

            ---

            ${{ github.event_name == 'issues' && 'Please provide:
            1. A brief summary of what this issue is requesting
            2. Key files that would likely need to be modified (based on the codebase structure)
            3. A step-by-step implementation plan
            4. Any potential challenges or considerations
            5. Estimated complexity (Low/Medium/High)

            Format your response in clear markdown. Be specific about file paths and code changes where possible.' || 'Please respond helpfully to the comment above. If asked for an implementation plan, provide one. If asked a question, answer it. If asked to clarify something, do so. Be specific about file paths and code changes where relevant.' }}
          allowed_tools: "Read,Glob,Grep"
          max_turns: "10"

      - name: Post response as comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ${{ github.event_name == 'issues' && '## Implementation Plan' || format('**Responding to @{0}:**', github.event.comment.user.login) }}

            ${{ steps.claude.outputs.response }}

            ---
            *Generated by Claude. Tag @claude in a comment to ask follow-up questions.*
